import React, { useRef, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import Navbar from '@/components/Navbar';
import AuthCheck from '../components/AuthCheck';
import { Printer, Download, Search, BarChart3, PieChart, TrendingUp, Activity, Target, ScatterChart as ScatterIcon, Circle } from 'lucide-react';
import { useReactToPrint } from 'react-to-print';
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, PieChart as RechartsPieChart, Pie, Cell, LineChart, Line, AreaChart, Area, RadarChart, Radar, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ScatterChart, Scatter, ZAxis, ResponsiveContainer } from 'recharts';
import { ChartContainer, ChartTooltip, ChartTooltipContent } from '@/components/ui/chart';

const StudentPerformanceAnalyzerPage: React.FC = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const state = location.state as {
    name?: string;
    usn?: string;
    semester?: number;
    subjects?: string[];
    if(percentage >= 90) return 10;
  if (percentage >= 80) return 9;
  if (percentage >= 70) return 8;
  if (percentage >= 60) return 7;
  if (percentage >= 50) return 6;
  if (percentage >= 40) return 5;
  return 4;
};

const calculateGrade = (sgpa: number) => {
  if (sgpa >= 9) return 'A+';
  if (sgpa >= 8) return 'A';
  if (sgpa >= 7) return 'B+';
  if (sgpa >= 6) return 'B';
  if (sgpa >= 5) return 'C';
  return 'F';
};

if (!state) {
  // Show search form if no state is provided
  return (
    <AuthCheck>
      <div className="min-h-screen bg-gray-50">
        <Navbar />
        <div className="container mx-auto px-4 py-8">
          <div className="max-w-md mx-auto">
            <Card>
              <CardHeader className="text-center">
                <div className="mx-auto w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                  <Search className="w-6 h-6 text-indigo-600" />
                </div>
                <CardTitle>Student Performance Analyzer</CardTitle>
                <CardDescription>
                  Enter student Name or USN to analyze performance data.
                </CardDescription>
              </CardHeader>
              <CardContent>
                <form onSubmit={handleSearch} className="space-y-4">
                  <div>
                    <Label htmlFor="searchName">Name (Optional)</Label>
                    <Input
                      id="searchName"
                      type="text"
                      value={searchName}
                      onChange={(e) => setSearchName(e.target.value)}
                      placeholder="Enter student name"
                    />
                  </div>
                  <div>
                    <Label htmlFor="searchUSN">USN (Optional)</Label>
                    <Input
                      id="searchUSN"
                      type="text"
                      value={searchUSN}
                      onChange={(e) => setSearchUSN(e.target.value)}
                      placeholder="Enter student USN"
                    />
                  </div>
                  <Button type="submit" className="w-full" disabled={isSearching}>
                    {isSearching ? 'Searching...' : 'Search Student'}
                  </Button>
                </form>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </AuthCheck>
  );
}

const { name, usn, semester, subjects, internalMarks, subjectCodes, internal, uploadedAt } = state;

// Prepare chart data
const chartData = subjects?.map((subject, index) => ({
  subject: subject.length > 20 ? subject.substring(0, 20) + '...' : subject,
  marks: internalMarks?.[index] || 0,
  fullSubject: subject
})) || [];

const pieData = chartData.map(item => ({
  name: item.subject,
  value: item.marks
}));

const chartConfig = {
  marks: {
    label: "Marks",
    color: "hsl(var(--chart-1))",
  },
};

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8', '#82CA9D'];

const handleDownloadPDF = async () => {
  if (!printRef.current) return;

  const canvas = await html2canvas(printRef.current);
  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF();
  const imgWidth = 210;
  const pageHeight = 295;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;
  let heightLeft = imgHeight;

  let position = 0;

  pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
  heightLeft -= pageHeight;

  while (heightLeft >= 0) {
    position = heightLeft - imgHeight;
    pdf.addPage();
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
  }

  pdf.save(`${usn}_semester_${semester}_performance.pdf`);
};

return (
  <AuthCheck>
    <div className="min-h-screen bg-gray-50">
      <Navbar />
      <div className="container mx-auto px-4 py-8">
        <div className="max-w-4xl mx-auto">
          <div ref={printRef} className="space-y-6">
            <Card>
              <CardHeader className="text-center">
                <CardTitle className="text-2xl">Student Performance Analysis</CardTitle>
                <CardDescription>
                  Semester {semester} Results for {name} ({usn})
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="mb-6">
                  <p className="text-sm text-gray-600">Uploaded At: {uploadedAt}</p>
                  <p className="text-sm text-gray-600">Selected Internal: {internal}</p>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Subject-wise Performance</CardTitle>
                <CardDescription>Detailed marks for each subject</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-2">
                  {subjects?.map((subject, index) => (
                    <div key={index} className="bg-gray-50 p-3 rounded">
                      <div className="font-medium mb-1">{subject}</div>
                      <div className="flex justify-between text-sm">
                        <span>Subject Code: {subjectCodes?.[index] || 'N/A'}</span>
                        <span>Internal: {internalMarks?.[index] || 'N/A'}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <BarChart3 className="w-5 h-5" />
                  Performance Visualization
                </CardTitle>
                <CardDescription>Visual representation of student marks</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="mb-4">
                  <Label htmlFor="chart-type">Chart Type</Label>
                  <Select value={selectedChartType} onValueChange={(value: 'bar' | 'pie' | 'line' | 'area' | 'column' | 'radar' | 'doughnut' | 'stacked-bar' | 'scatter' | 'bubble') => setSelectedChartType(value)}>
                    <SelectTrigger className="w-full">
                      <SelectValue placeholder="Select chart type" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="bar">
                        <div className="flex items-center gap-2">
                          <BarChart3 className="w-4 h-4" />
                          Bar Chart
                        </div>
                      </SelectItem>
                      <SelectItem value="pie">
                        <div className="flex items-center gap-2">
                          <PieChart className="w-4 h-4" />
                          Pie Chart
                        </div>
                      </SelectItem>
                      <SelectItem value="line">
                        <div className="flex items-center gap-2">
                          <TrendingUp className="w-4 h-4" />
                          Line Chart
                        </div>
                      </SelectItem>
                      <SelectItem value="area">
                        <div className="flex items-center gap-2">
                          <Activity className="w-4 h-4" />
                          Area Chart
                        </div>
                      </SelectItem>
                      <SelectItem value="column">
                        <div className="flex items-center gap-2">
                          <BarChart3 className="w-4 h-4" />
                          Column Chart
                        </div>
                      </SelectItem>
                      <SelectItem value="radar">
                        <div className="flex items-center gap-2">
                          <Target className="w-4 h-4" />
                          Radar Chart
                        </div>
                      </SelectItem>
                      <SelectItem value="doughnut">
                        <div className="flex items-center gap-2">
                          <Circle className="w-4 h-4" />
                          Doughnut Chart
                        </div>
                      </SelectItem>
                      <SelectItem value="stacked-bar">
                        <div className="flex items-center gap-2">
                          <BarChart3 className="w-4 h-4" />
                          Stacked Bar Chart
                        </div>
                      </SelectItem>
                      <SelectItem value="scatter">
                        <div className="flex items-center gap-2">
                          <ScatterIcon className="w-4 h-4" />
                          Scatter Plot
                        </div>
                      </SelectItem>
                      <SelectItem value="bubble">
                        <div className="flex items-center gap-2">
                          <Circle className="w-4 h-4" />
                          Bubble Chart
                        </div>
                      </SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="h-96 mb-8">
                  <ChartContainer config={chartConfig}>
                    {selectedChartType === 'bar' ? (
                      <BarChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis
                          dataKey="subject"
                          tick={{ fontSize: 12 }}
                          angle={-45}
                          textAnchor="end"
                          height={80}
                        />
                        <YAxis domain={[0, 50]} />
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                          labelFormatter={(label) => `Subject: ${label}`}
                        />
                        <Bar dataKey="marks" fill="var(--color-marks)" />
                      </BarChart>
                    ) : selectedChartType === 'pie' ? (
                      <RechartsPieChart>
                        <Pie
                          data={pieData}
                          cx="50%"
                          cy="50%"
                          innerRadius={40}
                          outerRadius={80}
                          label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                          fill="#8884d8"
                          dataKey="value"
                        >
                          {pieData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                          ))}
                        </Pie>
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                        />
                      </RechartsPieChart>
                    ) : selectedChartType === 'line' ? (
                      <LineChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis
                          dataKey="subject"
                          tick={{ fontSize: 12 }}
                          angle={-45}
                          textAnchor="end"
                          height={80}
                        />
                        <YAxis domain={[0, 50]} />
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                          labelFormatter={(label) => `Subject: ${label}`}
                        />
                        <Line type="monotone" dataKey="marks" stroke="var(--color-marks)" strokeWidth={2} />
                      </LineChart>
                    ) : selectedChartType === 'area' ? (
                      <AreaChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis
                          dataKey="subject"
                          tick={{ fontSize: 12 }}
                          angle={-45}
                          textAnchor="end"
                          height={80}
                        />
                        <YAxis domain={[0, 50]} />
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                          labelFormatter={(label) => `Subject: ${label}`}
                        />
                        <Area type="monotone" dataKey="marks" stroke="var(--color-marks)" fill="var(--color-marks)" fillOpacity={0.6} />
                      </AreaChart>
                    ) : selectedChartType === 'column' ? (
                      <BarChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis
                          dataKey="subject"
                          tick={{ fontSize: 12 }}
                          angle={-45}
                          textAnchor="end"
                          height={80}
                        />
                        <YAxis domain={[0, 50]} />
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                          labelFormatter={(label) => `Subject: ${label}`}
                        />
                        <Bar dataKey="marks" fill="var(--color-marks)" />
                      </BarChart>
                    ) : selectedChartType === 'radar' ? (
                      <RadarChart data={chartData}>
                        <PolarGrid />
                        <PolarAngleAxis dataKey="subject" />
                        <PolarRadiusAxis domain={[0, 50]} />
                        <Radar name="Marks" dataKey="marks" stroke="var(--color-marks)" fill="var(--color-marks)" fillOpacity={0.6} />
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                        />
                      </RadarChart>
                    ) : selectedChartType === 'doughnut' ? (
                      <RechartsPieChart>
                        <Pie
                          data={pieData}
                          cx="50%"
                          cy="50%"
                          innerRadius={40}
                          outerRadius={80}
                          label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                          fill="#8884d8"
                          dataKey="value"
                        >
                          {pieData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                          ))}
                        </Pie>
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                        />
                      </RechartsPieChart>
                    ) : selectedChartType === 'stacked-bar' ? (
                      <BarChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis
                          dataKey="subject"
                          tick={{ fontSize: 12 }}
                          angle={-45}
                          textAnchor="end"
                          height={80}
                        />
                        <YAxis domain={[0, 50]} />
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                          labelFormatter={(label) => `Subject: ${label}`}
                        />
                        <Bar dataKey="marks" stackId="a" fill="var(--color-marks)" />
                      </BarChart>
                    ) : selectedChartType === 'scatter' ? (
                      <ScatterChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis type="number" dataKey="marks" domain={[0, 50]} />
                        <YAxis type="category" dataKey="subject" />
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                          labelFormatter={(label) => `Subject: ${label}`}
                        />
                        <Scatter dataKey="marks" fill="var(--color-marks)" />
                      </ScatterChart>
                    ) : selectedChartType === 'bubble' ? (
                      <ScatterChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis type="number" dataKey="marks" domain={[0, 50]} />
                        <YAxis type="category" dataKey="subject" />
                        <ZAxis type="number" dataKey="marks" range={[100, 400]} />
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                          labelFormatter={(label) => `Subject: ${label}`}
                        />
                        <Scatter dataKey="marks" fill="var(--color-marks)" />
                      </ScatterChart>
                    ) : (
                      <BarChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis
                          dataKey="subject"
                          tick={{ fontSize: 12 }}
                          angle={-45}
                          textAnchor="end"
                          height={80}
                        />
                        <YAxis domain={[0, 50]} />
                        <ChartTooltip
                          content={<ChartTooltipContent />}
                          formatter={(value, name) => [`${value} marks`, 'Marks']}
                          labelFormatter={(label) => `Subject: ${label}`}
                        />
                        <Bar dataKey="marks" fill="var(--color-marks)" />
                      </BarChart>
                    )}
                  </ChartContainer>
                </div>
              </CardContent>
            </Card>
          </div>

          <div className="flex gap-4 mt-6">
            <Button onClick={handlePrint} className="flex-1">
              <Printer className="w-4 h-4 mr-2" />
              Print Report
            </Button>
            <Button onClick={handleDownloadPDF} variant="outline" className="flex-1">
              <Download className="w-4 h-4 mr-2" />
              Download PDF
            </Button>
          </div>
        </div>
      </div>
    </div>
  </AuthCheck>
);
};

export default StudentPerformanceAnalyzerPage;